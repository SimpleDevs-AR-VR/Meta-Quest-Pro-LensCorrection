# Meta Quest Pro Lens Correction

_A miniature project to find a way to correct the artificial lens distortion generated by the Meta Quest Pro when recording using `scrcpy` and `ffmpeg`._

This project assumes you have collected raw screen footage from a Meta Quest Pro or other Android-based head-mounted display (HMD) virtual/augmented reality headset. If not, we have a toolkit offered [here for the Meta Quest Pro](git@github.com:SimpleDevs-AR-VR/Meta-Quest-Pro-SCRCPY.git).

[![Watch the video](./docs/captured_footage.png)](https://youtu.be/zhfMPfGJFuc)

## Correcting for Distortion

We have two separate footage streams condensed into one single video, complete with artificial distortion.

![Raw SCRCPY Capture](./docs/raw_scrcpy_capture.png)

We want to attempt to correct for this artificial distortion so that we can begin to derive good footage of our AR/VR application in action. We can attempt to perform a kind of lens correction using FFMPEG.

The necessary steps are the following:

1. Crop the video so that left and right eye footage are separated into their own separate files.
2. Rotate the images so that they are as close to horizontal as possible.
3. Perform lens distortion correction to reduce the "fisheye" effect seen in the original footage for each eye.

## Commands and Parameters

**NOTE:** This is explicitly with regard to when recording with `m1280` when recordign with **scrcpy**.

**NOTE:** Please ensure that you have `-vsync 2` included as an argument passed to the **ffmpeg** command, as this ensures that all video processing occurs quickly.

### LEFT EYE

````bash
ffmpeg -i <INPUT_VIDEO_FILE> -vf "crop=632:672:16:0,rotate=21*(PI/180),lenscorrection=cx=0.57:cy=0.51:k1=-0.48:k2=0.2" -vsync 2 <OUTPUT_VIDEO_FILE>.mp4
````

### RIGHT EYE

````bash
ffmpeg -i <INPUT_VIDEO_FILE> -vf "crop=632:672:648:0,rotate=-21*(PI/180),lenscorrection=cx=0.43:cy=0.51:k1=-0.48:k2=0.2" -vsync 2 <OUTPUT_VIDEO_FILE>.mp
````

## Example

### Original:

![Original Source - approx 6:15](./docs/example_original.png)

### After Correction:

|Left|Right|
|:-:|:-:|
|![Left Eye - approx. 6:15](./docs/example_left.png)|![Right Eye - approx. 6:15](./docs/example_right.png)|

## Parameters for Correction

To learn more about each process, please refer to the following documentation provided in `docs/`:

* [**Cropping Parameters**](./docs/CROPPING.md)
* [**Rotation Parameters**](./docs/ROTATION.md)
* [**Lens Correction Parameter**](./docs/LENS_CORRECTION.md)
